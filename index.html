<script>
  let dropdownData = { GLAccounts: [], Departments: [] };

  async function loadDropdownData() {
    try {
      const response = await fetch("https://script.google.com/macros/s/AKfycbxV3yqKCTHgFYrfavqJhFgibtwkG-Q_cxqpb7W9Q6tJBROYvquNl48Ftaj4IpFeBypr/exec");
      const sheetData = await response.json();

      console.log("SheetDB raw data:", sheetData); // âœ… debug

      dropdownData = {
        GLAccounts: [...new Set(sheetData.map(row => row["NR_GL_Account"]).filter(v => !!v))],
        Departments: [...new Set(sheetData.map(row => row["NR_Department"]).filter(v => !!v))]
      };

      console.log("Extracted GLs:", dropdownData.GLAccounts);
      console.log("Extracted Departments:", dropdownData.Departments);

      addRow();
      addRow();
    } catch (err) {
      console.error("Failed to load dropdown data", err);
    }
  }

  function addRow() {
    if (!Array.isArray(dropdownData.GLAccounts) || !dropdownData.GLAccounts.length) {
      console.error("GLAccounts not ready");
      return;
    }

    if (!Array.isArray(dropdownData.Departments) || !dropdownData.Departments.length) {
      console.error("Departments not ready");
      return;
    }

    const tableBody = document.getElementById("table-body");
    const rowCount = tableBody.rows.length;
    const row = tableBody.insertRow();

    // GL Account
    const cell1 = row.insertCell(0);
    const glSelect = document.createElement("select");
    glSelect.name = `glAccount${rowCount}`;
    dropdownData.GLAccounts.forEach(val => {
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      glSelect.appendChild(opt);
    });
    cell1.appendChild(glSelect);

    // Department
    const cell2 = row.insertCell(1);
    const deptSelect = document.createElement("select");
    deptSelect.name = `department${rowCount}`;
    dropdownData.Departments.forEach(val => {
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      deptSelect.appendChild(opt);
    });
    cell2.appendChild(deptSelect);

    // Description
    const cell3 = row.insertCell(2);
    const descInput = document.createElement("input");
    descInput.type = "text";
    descInput.name = `description${rowCount}`;
    cell3.appendChild(descInput);

    // Amount
    const cell4 = row.insertCell(3);
    const amtInput = document.createElement("input");
    amtInput.type = "number";
    amtInput.step = "0.01";
    amtInput.name = `amount${rowCount}`;
    amtInput.oninput = calculateTotal;
    cell4.appendChild(amtInput);
  }

  function calculateTotal() {
    let total = 0;
    document.querySelectorAll('input[type="number"]').forEach(input => {
      const val = parseFloat(input.value);
      if (!isNaN(val)) total += val;
    });
    document.getElementById("grand-total").textContent = `$${total.toFixed(2)}`;
  }

  window.onload = loadDropdownData;
</script>
